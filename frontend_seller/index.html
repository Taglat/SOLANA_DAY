<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loyalty Platform - –ë–∏–∑–Ω–µ—Å</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex items-center justify-between">
                <h1 class="text-3xl font-bold text-blue-600">üè™ –ë–∏–∑–Ω–µ—Å –î–∞—à–±–æ—Ä–¥</h1>
                <div class="flex items-center space-x-4">
                    <div id="business-info" class="hidden">
                        <span class="text-sm text-gray-600">–ë–∏–∑–Ω–µ—Å:</span>
                        <span id="business-name" class="font-semibold text-sm bg-gray-100 px-2 py-1 rounded"></span>
                    </div>
                    <button id="login-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        –í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É
                    </button>
                </div>
            </div>
        </header>

        <!-- Analytics Cards -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">üë• –ö–ª–∏–µ–Ω—Ç—ã</h2>
                <div class="text-3xl font-bold text-blue-600 mb-2" id="total-customers">0</div>
                <div class="text-sm text-gray-500">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">ü™ô –¢–æ–∫–µ–Ω—ã</h2>
                <div class="text-3xl font-bold text-green-600 mb-2" id="tokens-issued">0</div>
                <div class="text-sm text-gray-500">–í—ã–¥–∞–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">üí∞ –í—ã—Ä—É—á–∫–∞</h2>
                <div class="text-3xl font-bold text-purple-600 mb-2" id="total-revenue">$0</div>
                <div class="text-sm text-gray-500">–ó–∞ –≤—Å–µ –≤—Ä–µ–º—è</div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">üìà ROI</h2>
                <div class="text-3xl font-bold text-orange-600 mb-2" id="roi-percentage">0%</div>
                <div class="text-sm text-gray-500">–ü—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</div>
            </div>
        </div>

        <!-- Receipt Generation -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">üßæ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ–∫–∞</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium mb-2">–ö–æ—à–µ–ª–µ–∫ –∫–ª–∏–µ–Ω—Ç–∞</label>
                    <input type="text" id="customer-wallet" class="w-full border rounded-lg px-3 py-2" placeholder="9WzDXwBbmkg8ZTbNMqUxvQRAyrZzDsGYdLVL9zYtAWWM">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">–°—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏ ($)</label>
                    <input type="number" id="purchase-amount" class="w-full border rounded-lg px-3 py-2" placeholder="15.50" step="0.01">
                </div>
            </div>
            <button id="generate-receipt" class="mt-4 bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                –°–æ–∑–¥–∞—Ç—å —á–µ–∫
            </button>
            <div id="receipt-result" class="hidden mt-4 p-4 bg-green-50 rounded-lg">
                <h3 class="font-semibold text-green-800 mb-2">–ß–µ–∫ —Å–æ–∑–¥–∞–Ω!</h3>
                <div id="receipt-details" class="text-sm text-green-700"></div>
                <div id="receipt-qr" class="mt-4 text-center"></div>
            </div>
        </div>

        <!-- QR Scanner -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">üì± –°–∫–∞–Ω–µ—Ä QR –∫–æ–¥–æ–≤</h2>
            <div id="qr-reader" class="mb-4"></div>
            <div id="scanned-result" class="hidden p-4 bg-green-100 rounded-lg">
                <h3 class="font-semibold text-green-800">QR –∫–æ–¥ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω!</h3>
                <div id="scanned-data" class="text-sm text-green-700 mt-2"></div>
                <button id="process-transaction" class="mt-3 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                    –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                </button>
            </div>
        </div>

        <!-- Settings -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium mb-2">–¢–æ–∫–µ–Ω–æ–≤ –∑–∞ $1</label>
                    <input type="number" id="tokens-per-dollar" class="w-full border rounded-lg px-3 py-2" value="10">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞ (%)</label>
                    <input type="number" id="max-discount" class="w-full border rounded-lg px-3 py-2" value="30" min="1" max="100">
                </div>
            </div>
            <button id="save-settings" class="mt-4 bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
        </div>
    </div>

    <script>
        // Mock business data
        let isLoggedIn = false;
        let businessId = '';
        let businessName = '';

        // DOM elements
        const loginBtn = document.getElementById('login-btn');
        const businessInfo = document.getElementById('business-info');
        const businessNameSpan = document.getElementById('business-name');
        const totalCustomers = document.getElementById('total-customers');
        const tokensIssued = document.getElementById('tokens-issued');
        const totalRevenue = document.getElementById('total-revenue');
        const roiPercentage = document.getElementById('roi-percentage');
        const scannedResult = document.getElementById('scanned-result');
        const scannedData = document.getElementById('scanned-data');
        const processTransactionBtn = document.getElementById('process-transaction');
        const tokensPerDollar = document.getElementById('tokens-per-dollar');
        const maxDiscount = document.getElementById('max-discount');
        const saveSettingsBtn = document.getElementById('save-settings');
        const customerWallet = document.getElementById('customer-wallet');
        const purchaseAmount = document.getElementById('purchase-amount');
        const generateReceiptBtn = document.getElementById('generate-receipt');
        const receiptResult = document.getElementById('receipt-result');
        const receiptDetails = document.getElementById('receipt-details');
        const receiptQr = document.getElementById('receipt-qr');

        // Login
        loginBtn.addEventListener('click', () => {
            if (!isLoggedIn) {
                // Mock login
                businessId = 'business_' + Math.random().toString(36).substr(2, 9);
                businessName = 'Coffee Shop';
                isLoggedIn = true;
                
                loginBtn.textContent = '–í—ã–π—Ç–∏';
                loginBtn.className = 'bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700';
                businessInfo.classList.remove('hidden');
                businessNameSpan.textContent = businessName;
                
                // Initialize dashboard
                loadAnalytics();
                initializeQRScanner();
            } else {
                // Logout
                isLoggedIn = false;
                businessId = '';
                businessName = '';
                loginBtn.textContent = '–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É';
                loginBtn.className = 'bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700';
                businessInfo.classList.add('hidden');
                scannedResult.classList.add('hidden');
            }
        });

        // Load analytics
        function loadAnalytics() {
            // Mock analytics data
            totalCustomers.textContent = Math.floor(Math.random() * 100) + 50;
            tokensIssued.textContent = Math.floor(Math.random() * 10000) + 5000;
            totalRevenue.textContent = '$' + (Math.random() * 5000 + 1000).toFixed(0);
            roiPercentage.textContent = (Math.random() * 50 + 20).toFixed(0) + '%';
        }

        // Initialize QR scanner
        function initializeQRScanner() {
            const html5QrcodeScanner = new Html5QrcodeScanner(
                "qr-reader",
                { fps: 10, qrbox: { width: 250, height: 250 } },
                false
            );

            html5QrcodeScanner.render(
                (decodedText) => {
                    try {
                        const data = JSON.parse(decodedText);
                        scannedData.innerHTML = `
                            <p><strong>–ö–æ—à–µ–ª–µ–∫:</strong> ${data.wallet_address?.slice(0, 8)}...</p>
                            <p><strong>–°—É–º–º–∞:</strong> $${data.amount_usd}</p>
                            <p><strong>–¢–∏–ø:</strong> ${data.type}</p>
                        `;
                        scannedResult.classList.remove('hidden');
                    } catch (error) {
                        console.error('Invalid QR code:', error);
                        alert('–ù–µ–≤–µ—Ä–Ω—ã–π QR –∫–æ–¥');
                    }
                },
                (error) => {
                    // Ignore scanning errors
                }
            );
        }

        // Process transaction
        processTransactionBtn.addEventListener('click', async () => {
            try {
                // Mock transaction processing
                alert('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
                scannedResult.classList.add('hidden');
                loadAnalytics();
            } catch (error) {
                console.error('Transaction processing error:', error);
                alert('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');
            }
        });

        // Generate receipt
        generateReceiptBtn.addEventListener('click', async () => {
            const wallet = customerWallet.value.trim();
            const amount = parseFloat(purchaseAmount.value);

            if (!wallet || !amount) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            try {
                // First create a purchase transaction
                const purchaseResponse = await fetch('http://localhost:8000/api/v1/transactions/purchase', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        customer_wallet: wallet,
                        business_id: businessId,
                        amount_usd: amount
                    })
                });

                if (purchaseResponse.ok) {
                    const transaction = await purchaseResponse.json();
                    
                    // Generate receipt
                    const receiptResponse = await fetch('http://localhost:8000/api/v1/receipts/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer mock-token'
                        },
                        body: JSON.stringify({
                            transaction_id: transaction.id,
                            business_id: businessId,
                            customer_wallet: wallet,
                            amount_usd: amount
                        })
                    });

                    if (receiptResponse.ok) {
                        const receipt = await receiptResponse.json();
                        
                        // Display receipt details
                        receiptDetails.innerHTML = `
                            <p><strong>ID —á–µ–∫–∞:</strong> ${receipt.id}</p>
                            <p><strong>–°—É–º–º–∞:</strong> $${receipt.amount_usd}</p>
                            <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${wallet.slice(0, 8)}...</p>
                            <p><strong>–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ:</strong> ${new Date(receipt.expires_at).toLocaleDateString()}</p>
                        `;

                        // Generate QR code
                        const qrData = JSON.parse(receipt.qr_code_data);
                        QRCode.toCanvas(document.createElement('canvas'), JSON.stringify(qrData), {
                            width: 200,
                            margin: 2
                        }, (err, canvas) => {
                            if (err) {
                                console.error('QR generation error:', err);
                                receiptQr.innerHTML = '<p class="text-red-600">–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞</p>';
                            } else {
                                receiptQr.innerHTML = '';
                                receiptQr.appendChild(canvas);
                            }
                        });

                        receiptResult.classList.remove('hidden');
                        
                        // Clear form
                        customerWallet.value = '';
                        purchaseAmount.value = '';
                        
                        // Update analytics
                        loadAnalytics();
                    } else {
                        const error = await receiptResponse.json();
                        alert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–µ–∫–∞: ${error.detail}`);
                    }
                } else {
                    const error = await purchaseResponse.json();
                    alert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: ${error.detail}`);
                }
            } catch (error) {
                console.error('Receipt generation error:', error);
                alert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —á–µ–∫–∞');
            }
        });

        // Save settings
        saveSettingsBtn.addEventListener('click', async () => {
            try {
                const settings = {
                    tokens_per_dollar: parseInt(tokensPerDollar.value),
                    max_discount_percent: parseInt(maxDiscount.value)
                };

                // Mock API call
                console.log('Saving settings:', settings);
                alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
            } catch (error) {
                console.error('Settings save error:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫');
            }
        });
    </script>
</body>
</html>