#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð»Ð¾ÑÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸ ÐºÐ¾Ñ„ÐµÐ¹Ð½Ð¸

echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð»Ð¾ÑÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸ ÐºÐ¾Ñ„ÐµÐ¹Ð½Ð¸"
echo "=================================="

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð² Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
if [ ! -f "docker-compose.yml" ]; then
    echo "âŒ Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¸Ð· ÐºÐ¾Ñ€Ð½ÐµÐ²Ð¾Ð¹ Ð¿Ð°Ð¿ÐºÐ¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°"
    exit 1
fi

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ð¾Ñ€Ñ‚Ð°
check_port() {
    if lsof -Pi :$1 -sTCP:LISTEN -t >/dev/null ; then
        echo "âœ… ÐŸÐ¾Ñ€Ñ‚ $1 ÑƒÐ¶Ðµ Ð·Ð°Ð½ÑÑ‚"
        return 0
    else
        echo "âŒ ÐŸÐ¾Ñ€Ñ‚ $1 ÑÐ²Ð¾Ð±Ð¾Ð´ÐµÐ½"
        return 1
    fi
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ Ð¿Ð¾Ñ€Ñ‚Ð¾Ð²
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ñ€Ñ‚Ð¾Ð²..."
check_port 8000
check_port 3000
check_port 3001

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ backend
echo ""
echo "ðŸ”§ Ð—Ð°Ð¿ÑƒÑÐº backend ÑÐµÑ€Ð²ÐµÑ€Ð°..."
if ! check_port 8000; then
    echo "Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ backend Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 8000..."
    cd backend
    python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000 &
    BACKEND_PID=$!
    cd ..
    echo "Backend Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ñ PID: $BACKEND_PID"
else
    echo "Backend ÑƒÐ¶Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
fi

# Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° backend
echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° backend..."
sleep 5

# Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ
echo ""
echo "ðŸ“¦ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ NFT ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸..."
python test_coffee_system.py

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ frontend ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
echo ""
echo "ðŸ‘¤ Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¾Ð³Ð¾ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
if ! check_port 3000; then
    echo "Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 3000..."
    cd frontend_client
    python -m http.server 3000 &
    CLIENT_PID=$!
    cd ..
    echo "ÐšÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾ Ñ PID: $CLIENT_PID"
else
    echo "ÐšÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ÑƒÐ¶Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾"
fi

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¸Ð·Ð½ÐµÑ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´
echo ""
echo "ðŸª Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¸Ð·Ð½ÐµÑ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´Ð°..."
if ! check_port 3001; then
    echo "Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¸Ð·Ð½ÐµÑ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 3001..."
    cd frontend_seller
    python -m http.server 3001 &
    SELLER_PID=$!
    cd ..
    echo "Ð‘Ð¸Ð·Ð½ÐµÑ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ñ PID: $SELLER_PID"
else
    echo "Ð‘Ð¸Ð·Ð½ÐµÑ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´ ÑƒÐ¶Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
fi

echo ""
echo "ðŸŽ‰ Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð°!"
echo "==================="
echo ""
echo "ðŸ“± Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÑ‹:"
echo "   â€¢ ÐšÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ: http://localhost:3000"
echo "   â€¢ Ð‘Ð¸Ð·Ð½ÐµÑ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´: http://localhost:3001"
echo "   â€¢ API Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ: http://localhost:8000/docs"
echo "   â€¢ ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ ÐºÐ°Ñ€Ñ‚Ð¸Ð½Ð¾Ðº: http://localhost:3000/images/nft_pictures/view_images.html"
echo ""
echo "ðŸŽ® Ð”ÐµÐ¼Ð¾-ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¹:"
echo "   1. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ"
echo "   2. ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ ÐºÐ¾ÑˆÐµÐ»ÐµÐº"
echo "   3. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð±Ð¸Ð·Ð½ÐµÑ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´"
echo "   4. Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ñ‡ÐµÐº Ð´Ð»Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°"
echo "   5. ÐžÑ‚ÑÐºÐ°Ð½Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ñ‡ÐµÐº Ð² ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¾Ð¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¸"
echo "   6. ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ñ‚Ðµ Ð½Ð° NFT ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸ÑŽ!"
echo ""
echo "ðŸ›‘ Ð”Ð»Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ Ctrl+C"

# Ð–Ð´ÐµÐ¼ ÑÐ¸Ð³Ð½Ð°Ð»Ð° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ
trap 'echo ""; echo "ðŸ›‘ ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹..."; kill $BACKEND_PID $CLIENT_PID $SELLER_PID 2>/dev/null; exit 0' INT

# Ð–Ð´ÐµÐ¼
wait
